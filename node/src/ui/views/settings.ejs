<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ARM - Settings</title>
  <link href="https://cdn.jsdelivr.net/npm/beercss@3.7.14/dist/cdn/beer.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
  <link rel="stylesheet" href="/static/css/style.css">
</head>
<body class="dark">
  <%- include('nav') %>
  <div class="page">
    <h5>Settings</h5>
    <div id="saveAlert" class="tertiary-container round padding" style="display:none;">
      <i>check_circle</i>
      <span>Settings saved successfully.</span>
    </div>
    <div id="saveError" class="error-container round padding" style="display:none;"></div>

    <% if (typeof config !== 'undefined') { %>
    <%
      var sections = {
        'Ripping': ['RIPMETHOD', 'MAINFEATURE', 'MINLENGTH', 'MAXLENGTH', 'RAW_PATH', 'TRANSCODE_PATH', 'COMPLETED_PATH', 'LOGPATH'],
        'Transcoding': ['SKIP_TRANSCODE', 'HB_PRESET_DVD', 'HB_PRESET_BD', 'HB_ARGS_DVD', 'HB_ARGS_BD', 'DEST_EXT', 'HANDBRAKE_CLI', 'USE_FFMPEG', 'FFMPEG_ARGS_DVD', 'FFMPEG_ARGS_BD', 'FFMPEG_PRE_ARGS_DVD', 'FFMPEG_PRE_ARGS_BD', 'MAX_CONCURRENT_TRANSCODES'],
        'Metadata': ['OMDB_API_KEY', 'TMDB_API_KEY', 'DATE_ADDED_TO_TITLE'],
        'AI Agent': ['AI_API_KEY', 'AI_API_URL', 'AI_MODEL'],
        'Notifications': ['NOTIFY_RIP', 'NOTIFY_TRANSCODE', 'PB_KEY', 'IFTTT_KEY', 'IFTTT_EVENT', 'PO_USER_KEY', 'PO_APP_KEY', 'JSON_URL'],
        'Media Server': ['EMBY_SERVER', 'EMBY_PORT', 'EMBY_API_KEY', 'EMBY_REFRESH']
      };
      var booleanKeys = ['SKIP_TRANSCODE', 'MAINFEATURE', 'HANDBRAKE_CLI', 'USE_FFMPEG', 'EMBY_REFRESH', 'NOTIFY_RIP', 'NOTIFY_TRANSCODE', 'DATE_ADDED_TO_TITLE'];
      var numberKeys = ['MINLENGTH', 'MAXLENGTH', 'EMBY_PORT', 'MAX_CONCURRENT_TRANSCODES'];
      var passwordKeys = ['AI_API_KEY', 'OMDB_API_KEY', 'TMDB_API_KEY', 'PB_KEY', 'IFTTT_KEY', 'PO_USER_KEY', 'PO_APP_KEY', 'EMBY_API_KEY'];
      var selectKeys = { RIPMETHOD: ['mkv', 'backup', 'backup_dvd'], DEST_EXT: ['mkv', 'mp4', 'avi'] };
    %>
    <form id="settingsForm">
      <% for (var sectionName in sections) { %>
        <article class="surface-container round" style="margin-top:1rem;">
          <h6><%= sectionName %></h6>
          <% sections[sectionName].forEach(function(key) { %>
            <div class="grid" style="align-items:center;margin-bottom:0.5rem;">
              <div class="s12 m4"><label for="<%= key %>"><code><%= key %></code></label></div>
              <div class="s12 m8">
                <% if (booleanKeys.indexOf(key) !== -1) { %>
                  <label class="switch">
                    <input type="checkbox" id="<%= key %>" name="<%= key %>" <%= config[key] === true ? 'checked' : '' %>>
                    <span></span>
                  </label>
                <% } else if (selectKeys[key]) { %>
                  <div class="field border round">
                    <select id="<%= key %>" name="<%= key %>">
                      <% selectKeys[key].forEach(function(opt) { %>
                        <option value="<%= opt %>" <%= config[key] === opt ? 'selected' : '' %>><%= opt %></option>
                      <% }); %>
                    </select>
                  </div>
                <% } else if (numberKeys.indexOf(key) !== -1) { %>
                  <div class="field border round">
                    <input type="number" id="<%= key %>" name="<%= key %>" value="<%= config[key] != null ? config[key] : '' %>">
                  </div>
                <% } else if (passwordKeys.indexOf(key) !== -1) { %>
                  <div class="field border round">
                    <input type="password" id="<%= key %>" name="<%= key %>" value="<%= config[key] || '' %>" autocomplete="off">
                  </div>
                <% } else { %>
                  <div class="field border round">
                    <input type="text" id="<%= key %>" name="<%= key %>" value="<%= config[key] != null ? config[key] : '' %>">
                  </div>
                <% } %>
              </div>
            </div>
          <% }); %>
        </article>
      <% } %>

      <article class="surface-container round" style="margin-top:1rem;">
        <h6>Other Settings</h6>
        <%
          var knownKeys = [];
          for (var s in sections) { knownKeys = knownKeys.concat(sections[s]); }
        %>
        <% for (var key in config) { %>
          <% if (knownKeys.indexOf(key) === -1) { %>
            <div class="grid" style="align-items:center;margin-bottom:0.5rem;">
              <div class="s12 m4"><label for="<%= key %>"><code><%= key %></code></label></div>
              <div class="s12 m8">
                <div class="field border round">
                  <input type="text" id="<%= key %>" name="<%= key %>" value="<%= config[key] != null ? config[key] : '' %>">
                </div>
              </div>
            </div>
          <% } %>
        <% } %>
      </article>

      <div style="margin-top:1rem;margin-bottom:1rem;">
        <button type="submit" class="primary small">Save Settings</button>
      </div>
    </form>
    <% } else { %>
      <article class="surface-container round" style="margin-top:1rem;">
        <p>No configuration loaded. Create <code>/etc/arm/config/arm.yaml</code> to get started.</p>
      </article>
    <% } %>

    <% if (typeof drives !== 'undefined' && drives.length > 0) { %>
      <article class="surface-container round" style="margin-top:1rem;">
        <h6>Optical Drives</h6>
        <table>
          <thead><tr><th>Name</th><th>Mount</th><th>Model</th><th>Mode</th><th>Actions</th></tr></thead>
          <tbody>
            <% drives.forEach(function(drive) { %>
              <tr>
                <td><%= drive.name %></td>
                <td><%= drive.mount %></td>
                <td><%= drive.model %></td>
                <td><%= drive.drive_mode %></td>
                <td><button class="small secondary" onclick="ejectDrive(<%= drive.drive_id %>)">Eject</button></td>
              </tr>
            <% }); %>
          </tbody>
        </table>
      </article>
    <% } %>
  </div>
  <script type="module" src="https://cdn.jsdelivr.net/npm/beercss@3.7.14/dist/cdn/beer.min.js"></script>
  <script type="module" src="https://cdn.jsdelivr.net/npm/material-dynamic-colors@1.1.4/dist/cdn/material-dynamic-colors.min.js"></script>
  <script>
    function ejectDrive(id) {
      fetch('/drive/eject/' + id, { method: 'POST' })
        .then(function(r) { return r.json(); })
        .then(function(d) { if (d.success) location.reload(); })
        .catch(function(e) { alert('Error: ' + e.message); });
    }

    document.getElementById('settingsForm').addEventListener('submit', function(e) {
      e.preventDefault();
      var formData = {};
      var inputs = this.querySelectorAll('input, select');
      inputs.forEach(function(input) {
        if (input.type === 'checkbox') {
          formData[input.name] = input.checked;
        } else if (input.type === 'number' && input.value !== '') {
          formData[input.name] = Number(input.value);
        } else {
          formData[input.name] = input.value;
        }
      });
      fetch('/save_settings', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(formData)
      })
        .then(function(r) { return r.json(); })
        .then(function(d) {
          if (d.success) {
            document.getElementById('saveAlert').style.display = '';
            document.getElementById('saveError').style.display = 'none';
            setTimeout(function() { document.getElementById('saveAlert').style.display = 'none'; }, 3000);
          } else {
            document.getElementById('saveError').textContent = d.error || 'Save failed';
            document.getElementById('saveError').style.display = '';
          }
        })
        .catch(function(e) {
          document.getElementById('saveError').textContent = 'Error: ' + e.message;
          document.getElementById('saveError').style.display = '';
        });
    });
  </script>
</body>
</html>
