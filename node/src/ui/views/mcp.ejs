<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= typeof title !== 'undefined' ? title : 'ARM - MCP Apps' %></title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="/static/css/style.css">
  <style>
    .mcp-app-frame {
      width: 100%;
      min-height: 400px;
      border: 1px solid #dee2e6;
      border-radius: 0.375rem;
      background: #fff;
    }
    .tool-call-form .form-control { font-family: monospace; font-size: 0.9rem; }
    .tool-result { max-height: 400px; overflow-y: auto; }
    .tool-result pre { white-space: pre-wrap; word-break: break-word; }
    .ui-tool-badge { cursor: pointer; }
  </style>
</head>
<body>
  <%- include('nav') %>
  <div class="container-fluid mt-3">
    <h2>MCP Apps</h2>
    <p class="text-muted">
      ARM uses the <a href="https://modelcontextprotocol.io" target="_blank">Model Context Protocol (MCP)</a>
      to connect to external tool servers — media databases, file organizers, metadata providers, and more.
    </p>

    <div class="row mt-3">
      <div class="col-md-3">
        <div class="card">
          <div class="card-body text-center">
            <h5 class="card-title">Configured</h5>
            <p class="display-6"><%= configuredCount %></p>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card">
          <div class="card-body text-center">
            <h5 class="card-title">Connected</h5>
            <p class="display-6 <%= connectedCount > 0 ? 'text-success' : 'text-muted' %>"><%= connectedCount %></p>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card">
          <div class="card-body text-center">
            <h5 class="card-title">Tools</h5>
            <p class="display-6"><%= tools.length %></p>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card">
          <div class="card-body text-center">
            <h5 class="card-title">App UIs</h5>
            <p class="display-6 <%= resources.filter(function(r) { return r.uri.startsWith('ui://'); }).length > 0 ? 'text-info' : 'text-muted' %>"><%= resources.filter(function(r) { return r.uri.startsWith('ui://'); }).length %></p>
          </div>
        </div>
      </div>
    </div>

    <% if (configs.length > 0) { %>
      <div class="card mt-4">
        <div class="card-header"><h5>Configured MCP Apps</h5></div>
        <div class="card-body">
          <table class="table table-striped">
            <thead>
              <tr><th>Name</th><th>Transport</th><th>Command / URL</th></tr>
            </thead>
            <tbody>
              <% configs.forEach(function(cfg) { %>
                <tr>
                  <td><%= cfg.name %></td>
                  <td><%= cfg.command ? 'stdio' : 'http' %></td>
                  <td><code><%= cfg.command ? (cfg.command + ' ' + (cfg.args || []).join(' ')) : cfg.url %></code></td>
                </tr>
              <% }); %>
            </tbody>
          </table>
        </div>
      </div>
    <% } %>

    <% var uiResources = resources.filter(function(r) { return r.uri.startsWith('ui://'); }); %>
    <% if (uiResources.length > 0) { %>
      <div class="card mt-4">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">MCP App UIs</h5>
          <span class="badge bg-info"><%= uiResources.length %> available</span>
        </div>
        <div class="card-body">
          <p class="text-muted">Interactive UIs provided by connected MCP apps via <a href="https://github.com/modelcontextprotocol/ext-apps" target="_blank">SEP-1865 MCP Apps</a>.</p>
          <% uiResources.forEach(function(res, idx) { %>
            <div class="mb-3">
              <button class="btn btn-outline-primary" type="button" data-bs-toggle="collapse" data-bs-target="#mcpApp<%= idx %>">
                <%= res.name || res.uri %> <span class="badge bg-secondary"><%= res.appName %></span>
              </button>
              <div class="collapse mt-2" id="mcpApp<%= idx %>">
                <div class="card card-body">
                  <p class="text-muted mb-2"><%= res.description || '' %></p>
                  <iframe
                    class="mcp-app-frame"
                    id="mcpAppFrame<%= idx %>"
                    sandbox="allow-scripts"
                    data-app-name="<%= res.appName %>"
                    data-resource-uri="<%= res.uri %>"
                  ></iframe>
                  <div class="mt-2">
                    <button class="btn btn-sm btn-primary" onclick="loadMcpAppUi(<%= idx %>, '<%= res.appName %>', '<%= res.uri %>')">Load App UI</button>
                  </div>
                </div>
              </div>
            </div>
          <% }); %>
        </div>
      </div>
    <% } %>

    <% if (tools.length > 0) { %>
      <div class="card mt-4">
        <div class="card-header"><h5>Available Tools</h5></div>
        <div class="card-body">
          <table class="table table-striped">
            <thead>
              <tr><th>App</th><th>Tool</th><th>Description</th><th>Action</th></tr>
            </thead>
            <tbody>
              <% tools.forEach(function(tool, idx) { %>
                <tr>
                  <td><span class="badge bg-primary"><%= tool.appName %></span></td>
                  <td><code><%= tool.name %></code></td>
                  <td><%= tool.description || '' %></td>
                  <td>
                    <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="collapse" data-bs-target="#toolCall<%= idx %>">
                      Try
                    </button>
                  </td>
                </tr>
                <tr class="collapse" id="toolCall<%= idx %>">
                  <td colspan="4">
                    <div class="tool-call-form p-2">
                      <div class="mb-2">
                        <label class="form-label">Arguments (JSON)</label>
                        <input type="text" class="form-control form-control-sm" id="toolArgs<%= idx %>" placeholder='{"title": "Inception"}'>
                      </div>
                      <button class="btn btn-sm btn-primary" onclick="callMcpTool('<%= tool.name %>', <%= idx %>)">Call</button>
                      <div class="tool-result mt-2" id="toolResult<%= idx %>" style="display:none;">
                        <pre class="bg-light p-2 rounded border"></pre>
                      </div>
                    </div>
                  </td>
                </tr>
              <% }); %>
            </tbody>
          </table>
        </div>
      </div>
    <% } else if (configs.length === 0) { %>
      <div class="alert alert-info mt-4">
        <h5>No MCP Apps Configured</h5>
        <p>Add MCP app servers to your <code>arm.yaml</code> configuration to extend ARM with external tools.</p>
        <p><strong>Example: OMDB Movie Database</strong> (<a href="https://github.com/shelbeely/omdb-mcp-server" target="_blank">omdb-mcp-server</a>)</p>
        <pre><code>MCP_APPS:
  - name: omdb
    command: npx
    args: ["-y", "omdb-mcp-server"]
    env:
      OMDB_API_KEY: "your-omdb-api-key"</code></pre>
        <p class="mb-0">Get a free OMDB API key at <a href="https://omdbapi.com/apikey.aspx" target="_blank">omdbapi.com</a>.</p>
      </div>
    <% } %>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Call an MCP tool and display the result
    async function callMcpTool(toolName, idx) {
      var argsInput = document.getElementById('toolArgs' + idx);
      var resultDiv = document.getElementById('toolResult' + idx);
      var resultPre = resultDiv.querySelector('pre');
      var args = {};
      try {
        if (argsInput.value.trim()) args = JSON.parse(argsInput.value);
      } catch (e) {
        resultPre.textContent = 'Invalid JSON: ' + e.message;
        resultDiv.style.display = 'block';
        return;
      }
      resultPre.textContent = 'Calling...';
      resultDiv.style.display = 'block';
      try {
        var resp = await fetch('/api/mcp/call', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ toolName: toolName, args: args })
        });
        var data = await resp.json();
        if (data.success && data.result) {
          // MCP tool results are in content array with text type
          if (data.result.content) {
            var text = data.result.content
              .filter(function(c) { return c.type === 'text'; })
              .map(function(c) { return c.text; })
              .join('\n');
            resultPre.textContent = text || JSON.stringify(data.result, null, 2);
          } else {
            resultPre.textContent = JSON.stringify(data.result, null, 2);
          }
          // Forward result to any active MCP App iframe for this tool
          forwardToolResultToApps(toolName, data.result);
        } else {
          resultPre.textContent = data.error || 'No result';
        }
      } catch (e) {
        resultPre.textContent = 'Error: ' + e.message;
      }
    }

    // MCP Apps host: active iframe references
    var mcpAppFrames = {};

    // Load an MCP App UI into an iframe
    async function loadMcpAppUi(idx, appName, resourceUri) {
      var iframe = document.getElementById('mcpAppFrame' + idx);
      try {
        var resp = await fetch('/api/mcp/resource?appName=' + encodeURIComponent(appName) + '&uri=' + encodeURIComponent(resourceUri));
        var contentType = resp.headers.get('content-type') || '';
        if (contentType.includes('html')) {
          var html = await resp.text();
          iframe.srcdoc = html;
          mcpAppFrames[resourceUri] = iframe;
        } else {
          var data = await resp.json();
          if (data.success && data.content && data.content.text) {
            iframe.srcdoc = data.content.text;
            mcpAppFrames[resourceUri] = iframe;
          }
        }
      } catch (e) {
        iframe.srcdoc = '<p style="color:red;padding:20px;">Failed to load MCP App UI: ' + e.message + '</p>';
      }
    }

    // SEP-1865 host: handle messages from MCP App iframes
    window.addEventListener('message', function(event) {
      try {
        var msg = typeof event.data === 'string' ? JSON.parse(event.data) : event.data;
        if (!msg || !msg.method) {
          // Check if it's a response (has id and result) — ignore
          return;
        }

        switch (msg.method) {
          case 'ui/initialize':
            // Respond with host context and protocol version
            var sourceFrame = findSourceFrame(event.source);
            if (sourceFrame) {
              var isDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
              event.source.postMessage(JSON.stringify({
                jsonrpc: '2.0',
                id: msg.id,
                result: {
                  protocolVersion: '2026-01-26',
                  hostInfo: { name: 'arm-ripping-machine', version: '1.0.0' },
                  hostContext: {
                    theme: isDark ? 'dark' : 'light'
                  }
                }
              }), '*');
            }
            break;

          case 'ui/notifications/initialized':
            // App is ready — no action needed
            break;

          default:
            break;
        }
      } catch (e) {
        // Ignore non-MCP messages
      }
    });

    // Find which iframe sent a message
    function findSourceFrame(source) {
      for (var uri in mcpAppFrames) {
        if (mcpAppFrames[uri].contentWindow === source) {
          return mcpAppFrames[uri];
        }
      }
      return null;
    }

    // Forward a tool result to any MCP App iframes that are listening
    function forwardToolResultToApps(toolName, result) {
      for (var uri in mcpAppFrames) {
        var frame = mcpAppFrames[uri];
        if (frame && frame.contentWindow) {
          try {
            frame.contentWindow.postMessage(JSON.stringify({
              jsonrpc: '2.0',
              method: 'ui/notifications/tool-result',
              params: result
            }), '*');
          } catch (e) {
            // ignore
          }
        }
      }
    }
  </script>
</body>
</html>
