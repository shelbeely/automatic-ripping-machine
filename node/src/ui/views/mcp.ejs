<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= typeof title !== 'undefined' ? title : 'ARM - MCP Apps' %></title>
  <link href="https://cdn.jsdelivr.net/npm/beercss@3.7.14/dist/cdn/beer.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
  <link rel="stylesheet" href="/static/css/style.css">
  <style>
    .mcp-app-frame {
      width: 100%;
      min-height: 400px;
      border: 1px solid var(--outline);
      border-radius: 0.75rem;
      background: #fff;
    }
    .tool-result { max-height: 400px; overflow-y: auto; }
    .tool-result pre { white-space: pre-wrap; word-break: break-word; }
  </style>
</head>
<body class="dark">
  <%- include('nav') %>
  <div class="page">
    <h5>MCP Apps</h5>
    <p>
      ARM uses the <a href="https://modelcontextprotocol.io" target="_blank">Model Context Protocol (MCP)</a>
      to connect to external tool servers — media databases, file organizers, metadata providers, and more.
    </p>

    <div class="grid">
      <div class="s6 m3">
        <article class="surface-container round" style="text-align:center;">
          <h6>Configured</h6>
          <p style="font-size:1.5rem;"><%= configuredCount %></p>
        </article>
      </div>
      <div class="s6 m3">
        <article class="surface-container round" style="text-align:center;">
          <h6>Connected</h6>
          <p style="font-size:1.5rem;"><span class="chip <%= connectedCount > 0 ? 'tertiary' : '' %>"><%= connectedCount %></span></p>
        </article>
      </div>
      <div class="s6 m3">
        <article class="surface-container round" style="text-align:center;">
          <h6>Tools</h6>
          <p style="font-size:1.5rem;"><%= tools.length %></p>
        </article>
      </div>
      <div class="s6 m3">
        <article class="surface-container round" style="text-align:center;">
          <h6>App UIs</h6>
          <p style="font-size:1.5rem;"><span class="chip <%= resources.filter(function(r) { return r.uri.startsWith('ui://'); }).length > 0 ? 'primary' : '' %>"><%= resources.filter(function(r) { return r.uri.startsWith('ui://'); }).length %></span></p>
        </article>
      </div>
    </div>

    <% if (configs.length > 0) { %>
      <article class="surface-container round" style="margin-top:1rem;">
        <h6>Configured MCP Apps</h6>
        <table class="stripes">
          <thead>
            <tr><th>Name</th><th>Transport</th><th>Command / URL</th></tr>
          </thead>
          <tbody>
            <% configs.forEach(function(cfg) { %>
              <tr>
                <td><%= cfg.name %></td>
                <td><%= cfg.command ? 'stdio' : 'http' %></td>
                <td><code><%= cfg.command ? (cfg.command + ' ' + (cfg.args || []).join(' ')) : cfg.url %></code></td>
              </tr>
            <% }); %>
          </tbody>
        </table>
      </article>
    <% } %>

    <% var uiResources = resources.filter(function(r) { return r.uri.startsWith('ui://'); }); %>
    <% if (uiResources.length > 0) { %>
      <article class="surface-container round" style="margin-top:1rem;">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <h6>MCP App UIs</h6>
          <span class="chip small primary"><%= uiResources.length %> available</span>
        </div>
        <p>Interactive UIs provided by connected MCP apps via <a href="https://github.com/modelcontextprotocol/ext-apps" target="_blank">SEP-1865 MCP Apps</a>.</p>
        <% uiResources.forEach(function(res, idx) { %>
          <div style="margin-bottom:0.75rem;">
            <button class="small border" onclick="toggleTry('mcpApp<%= idx %>')">
              <%= res.name || res.uri %> <span class="chip small"><%= res.appName %></span>
            </button>
            <div id="mcpApp<%= idx %>" style="display:none;margin-top:0.5rem;">
              <article class="surface-container round">
                <p><%= res.description || '' %></p>
                <iframe
                  class="mcp-app-frame"
                  id="mcpAppFrame<%= idx %>"
                  sandbox="allow-scripts"
                  data-app-name="<%= res.appName %>"
                  data-resource-uri="<%= res.uri %>"
                ></iframe>
                <div style="margin-top:0.5rem;">
                  <button class="small primary" onclick="loadMcpAppUi(<%= idx %>, '<%= res.appName %>', '<%= res.uri %>')">Load App UI</button>
                </div>
              </article>
            </div>
          </div>
        <% }); %>
      </article>
    <% } %>

    <% if (tools.length > 0) { %>
      <article class="surface-container round" style="margin-top:1rem;">
        <h6>Available Tools</h6>
        <table class="stripes">
          <thead>
            <tr><th>App</th><th>Tool</th><th>Description</th><th>Action</th></tr>
          </thead>
          <tbody>
            <% tools.forEach(function(tool, idx) { %>
              <tr>
                <td><span class="chip small primary"><%= tool.appName %></span></td>
                <td><code><%= tool.name %></code></td>
                <td><%= tool.description || '' %></td>
                <td>
                  <button class="small border" onclick="toggleTry('toolCall<%= idx %>')">Try</button>
                </td>
              </tr>
              <tr id="toolCall<%= idx %>" style="display:none;">
                <td colspan="4">
                  <div style="padding:0.5rem;">
                    <div class="field border round" style="font-family:monospace;">
                      <input type="text" id="toolArgs<%= idx %>" placeholder='{"title": "Inception"}'>
                      <label>Arguments (JSON)</label>
                    </div>
                    <button class="small primary" onclick="callMcpTool('<%= tool.name %>', <%= idx %>)">Call</button>
                    <div class="tool-result" id="toolResult<%= idx %>" style="display:none;margin-top:0.5rem;">
                      <pre class="surface-container round padding"></pre>
                    </div>
                  </div>
                </td>
              </tr>
            <% }); %>
          </tbody>
        </table>
      </article>
    <% } else if (configs.length === 0) { %>
      <article class="primary-container round padding" style="margin-top:1rem;">
        <h6>No MCP Apps Configured</h6>
        <p>Add MCP app servers to your <code>arm.yaml</code> configuration to extend ARM with external tools.</p>
        <p><strong>Example: OMDB Movie Database</strong> (<a href="https://github.com/shelbeely/omdb-mcp-server" target="_blank">omdb-mcp-server</a>)</p>
        <pre><code>MCP_APPS:
  - name: omdb
    command: npx
    args: ["-y", "omdb-mcp-server"]
    env:
      OMDB_API_KEY: "your-omdb-api-key"</code></pre>
        <p>Get a free OMDB API key at <a href="https://omdbapi.com/apikey.aspx" target="_blank">omdbapi.com</a>.</p>
      </article>
    <% } %>
  </div>

  <script type="module" src="https://cdn.jsdelivr.net/npm/beercss@3.7.14/dist/cdn/beer.min.js"></script>
  <script type="module" src="https://cdn.jsdelivr.net/npm/material-dynamic-colors@1.1.4/dist/cdn/material-dynamic-colors.min.js"></script>
  <script>
    function toggleTry(id) {
      var el = document.getElementById(id);
      el.style.display = el.style.display === 'none' ? '' : 'none';
    }

    // Call an MCP tool and display the result
    async function callMcpTool(toolName, idx) {
      var argsInput = document.getElementById('toolArgs' + idx);
      var resultDiv = document.getElementById('toolResult' + idx);
      var resultPre = resultDiv.querySelector('pre');
      var args = {};
      try {
        if (argsInput.value.trim()) args = JSON.parse(argsInput.value);
      } catch (e) {
        resultPre.textContent = 'Invalid JSON: ' + e.message;
        resultDiv.style.display = 'block';
        return;
      }
      resultPre.textContent = 'Calling...';
      resultDiv.style.display = 'block';
      try {
        var resp = await fetch('/api/mcp/call', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ toolName: toolName, args: args })
        });
        var data = await resp.json();
        if (data.success && data.result) {
          // MCP tool results are in content array with text type
          if (data.result.content) {
            var text = data.result.content
              .filter(function(c) { return c.type === 'text'; })
              .map(function(c) { return c.text; })
              .join('\n');
            resultPre.textContent = text || JSON.stringify(data.result, null, 2);
          } else {
            resultPre.textContent = JSON.stringify(data.result, null, 2);
          }
          // Forward result to any active MCP App iframe for this tool
          forwardToolResultToApps(toolName, data.result);
        } else {
          resultPre.textContent = data.error || 'No result';
        }
      } catch (e) {
        resultPre.textContent = 'Error: ' + e.message;
      }
    }

    // MCP Apps host: active iframe references
    var mcpAppFrames = {};

    // Load an MCP App UI into an iframe
    async function loadMcpAppUi(idx, appName, resourceUri) {
      var iframe = document.getElementById('mcpAppFrame' + idx);
      try {
        var resp = await fetch('/api/mcp/resource?appName=' + encodeURIComponent(appName) + '&uri=' + encodeURIComponent(resourceUri));
        var contentType = resp.headers.get('content-type') || '';
        if (contentType.includes('html')) {
          var html = await resp.text();
          iframe.srcdoc = html;
          mcpAppFrames[resourceUri] = iframe;
        } else {
          var data = await resp.json();
          if (data.success && data.content && data.content.text) {
            iframe.srcdoc = data.content.text;
            mcpAppFrames[resourceUri] = iframe;
          }
        }
      } catch (e) {
        iframe.srcdoc = '<p style="color:red;padding:20px;">Failed to load MCP App UI: ' + e.message + '</p>';
      }
    }

    // SEP-1865 host: handle messages from MCP App iframes
    window.addEventListener('message', function(event) {
      try {
        var msg = typeof event.data === 'string' ? JSON.parse(event.data) : event.data;
        if (!msg || !msg.method) {
          // Ignore non-MCP messages and JSON-RPC responses (have id+result but no method)
          return;
        }

        // Only process messages from known MCP App iframes
        var sourceFrame = findSourceFrame(event.source);
        if (!sourceFrame) return;

        switch (msg.method) {
          case 'ui/initialize':
            // Respond with host context and protocol version
            var isDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
            // srcdoc iframes have null origin, so '*' is required for postMessage
            event.source.postMessage(JSON.stringify({
              jsonrpc: '2.0',
              id: msg.id,
              result: {
                protocolVersion: '2026-01-26',
                hostInfo: { name: 'arm-ripping-machine', version: '1.0.0' },
                hostContext: {
                  theme: isDark ? 'dark' : 'light'
                }
              }
            }), '*');
            }
            break;

          case 'ui/notifications/initialized':
            // App is ready — no action needed
            break;

          default:
            break;
        }
      } catch (e) {
        // Ignore non-MCP messages
      }
    });

    // Find which iframe sent a message
    function findSourceFrame(source) {
      for (var uri in mcpAppFrames) {
        if (mcpAppFrames[uri].contentWindow === source) {
          return mcpAppFrames[uri];
        }
      }
      return null;
    }

    // Forward a tool result to any MCP App iframes that are listening
    // srcdoc iframes have null origin, so '*' is required for postMessage
    function forwardToolResultToApps(toolName, result) {
      for (var uri in mcpAppFrames) {
        var frame = mcpAppFrames[uri];
        if (frame && frame.contentWindow) {
          try {
            frame.contentWindow.postMessage(JSON.stringify({
              jsonrpc: '2.0',
              method: 'ui/notifications/tool-result',
              params: result
            }), '*');
          } catch (e) {
            // ignore postMessage errors for detached frames
          }
        }
      }
    }
  </script>
</body>
</html>
