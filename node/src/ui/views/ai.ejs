<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= typeof title !== 'undefined' ? title : 'ARM - AI Dashboard' %></title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
  <%- include('nav') %>
  <div class="container-fluid mt-3">
    <h2>AI Dashboard</h2>
    <p class="text-muted">
      ARM uses AI to enhance disc identification, optimize transcode settings, diagnose errors, generate
      media-library filenames, and fetch structured metadata for MKV tagging.
    </p>

    <div class="row mt-3">
      <div class="col-md-4">
        <div class="card">
          <div class="card-body text-center">
            <h5 class="card-title">AI Status</h5>
            <p class="display-6 <%= aiConfigured ? 'text-success' : 'text-danger' %>"><%= aiConfigured ? 'Active' : 'Not Configured' %></p>
            <% if (!aiConfigured) { %>
              <small class="text-muted">Set <code>AI_API_KEY</code> in arm.yaml</small>
            <% } %>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card">
          <div class="card-body text-center">
            <h5 class="card-title">Model</h5>
            <p class="display-6" style="font-size: 1.5rem;"><%= aiModel %></p>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card">
          <div class="card-body text-center">
            <h5 class="card-title">Capabilities</h5>
            <p class="display-6">5</p>
          </div>
        </div>
      </div>
    </div>

    <!-- AI Capabilities -->
    <div class="card mt-4">
      <div class="card-header"><h5>AI Capabilities</h5></div>
      <div class="card-body">
        <table class="table table-striped">
          <thead>
            <tr><th>Capability</th><th>Description</th><th>API Endpoint</th><th>Try</th></tr>
          </thead>
          <tbody>
            <tr>
              <td><strong>Disc Identification</strong></td>
              <td>Parse disc labels to identify movie/TV show titles, years, and types</td>
              <td><code>POST /api/ai/identify</code></td>
              <td><button class="btn btn-sm btn-outline-primary" data-bs-toggle="collapse" data-bs-target="#tryIdentify">Try</button></td>
            </tr>
            <tr class="collapse" id="tryIdentify">
              <td colspan="4">
                <div class="p-2">
                  <div class="row g-2">
                    <div class="col-md-8">
                      <input type="text" class="form-control form-control-sm" id="identifyLabel" placeholder="Disc label (e.g., STAR_WARS_EP_IV)">
                    </div>
                    <div class="col-md-2">
                      <select class="form-control form-control-sm" id="identifyDisctype">
                        <option value="unknown">Unknown</option>
                        <option value="dvd">DVD</option>
                        <option value="bluray">Blu-ray</option>
                      </select>
                    </div>
                    <div class="col-md-2">
                      <button class="btn btn-sm btn-primary w-100" onclick="tryIdentify()">Call</button>
                    </div>
                  </div>
                  <div class="mt-2" id="identifyResult" style="display:none;"><pre class="bg-dark text-light p-2 rounded"></pre></div>
                </div>
              </td>
            </tr>
            <tr>
              <td><strong>Transcode Optimization</strong></td>
              <td>Recommend optimal transcode settings based on video properties and disc type</td>
              <td><code>POST /api/ai/transcode</code></td>
              <td><button class="btn btn-sm btn-outline-primary" data-bs-toggle="collapse" data-bs-target="#tryTranscode">Try</button></td>
            </tr>
            <tr class="collapse" id="tryTranscode">
              <td colspan="4">
                <div class="p-2">
                  <div class="row g-2">
                    <div class="col-md-10">
                      <input type="text" class="form-control form-control-sm" id="transcodeInfo" placeholder='Video info JSON (e.g., {"resolution":"1920x1080","codec":"h264"})'>
                    </div>
                    <div class="col-md-2">
                      <button class="btn btn-sm btn-primary w-100" onclick="tryTranscode()">Call</button>
                    </div>
                  </div>
                  <div class="mt-2" id="transcodeResult" style="display:none;"><pre class="bg-dark text-light p-2 rounded"></pre></div>
                </div>
              </td>
            </tr>
            <tr>
              <td><strong>Error Diagnosis</strong></td>
              <td>Analyze ripping/transcoding errors and provide actionable troubleshooting steps</td>
              <td><code>POST /api/ai/diagnose</code></td>
              <td><button class="btn btn-sm btn-outline-primary" data-bs-toggle="collapse" data-bs-target="#tryDiagnose">Try</button></td>
            </tr>
            <tr class="collapse" id="tryDiagnose">
              <td colspan="4">
                <div class="p-2">
                  <div class="row g-2">
                    <div class="col-md-10">
                      <textarea class="form-control form-control-sm" id="diagnoseLog" rows="2" placeholder="Paste error log here..."></textarea>
                    </div>
                    <div class="col-md-2">
                      <button class="btn btn-sm btn-primary w-100" onclick="tryDiagnose()">Call</button>
                    </div>
                  </div>
                  <div class="mt-2" id="diagnoseResult" style="display:none;"><pre class="bg-dark text-light p-2 rounded"></pre></div>
                </div>
              </td>
            </tr>
            <tr>
              <td><strong>Filename Generation</strong></td>
              <td>Generate Plex/Emby/Jellyfin-compatible filenames and directory structures</td>
              <td><code>POST /api/ai/filename</code></td>
              <td><button class="btn btn-sm btn-outline-primary" data-bs-toggle="collapse" data-bs-target="#tryFilename">Try</button></td>
            </tr>
            <tr class="collapse" id="tryFilename">
              <td colspan="4">
                <div class="p-2">
                  <div class="row g-2">
                    <div class="col-md-5">
                      <input type="text" class="form-control form-control-sm" id="filenameTitle" placeholder="Movie title">
                    </div>
                    <div class="col-md-2">
                      <input type="text" class="form-control form-control-sm" id="filenameYear" placeholder="Year">
                    </div>
                    <div class="col-md-3">
                      <select class="form-control form-control-sm" id="filenameType">
                        <option value="movie">Movie</option>
                        <option value="series">Series</option>
                      </select>
                    </div>
                    <div class="col-md-2">
                      <button class="btn btn-sm btn-primary w-100" onclick="tryFilename()">Call</button>
                    </div>
                  </div>
                  <div class="mt-2" id="filenameResult" style="display:none;"><pre class="bg-dark text-light p-2 rounded"></pre></div>
                </div>
              </td>
            </tr>
            <tr>
              <td><strong>Credits &amp; Metadata</strong></td>
              <td>Fetch structured credits (cast, crew, synopsis, genre, ratings) for MKV tagging</td>
              <td><code>POST /api/ai/credits</code></td>
              <td><button class="btn btn-sm btn-outline-primary" data-bs-toggle="collapse" data-bs-target="#tryCredits">Try</button></td>
            </tr>
            <tr class="collapse" id="tryCredits">
              <td colspan="4">
                <div class="p-2">
                  <div class="row g-2">
                    <div class="col-md-6">
                      <input type="text" class="form-control form-control-sm" id="creditsTitle" placeholder="Movie title">
                    </div>
                    <div class="col-md-2">
                      <input type="text" class="form-control form-control-sm" id="creditsYear" placeholder="Year">
                    </div>
                    <div class="col-md-2">
                      <select class="form-control form-control-sm" id="creditsType">
                        <option value="movie">Movie</option>
                        <option value="series">Series</option>
                      </select>
                    </div>
                    <div class="col-md-2">
                      <button class="btn btn-sm btn-primary w-100" onclick="tryCredits()">Call</button>
                    </div>
                  </div>
                  <div class="mt-2" id="creditsResult" style="display:none;"><pre class="bg-dark text-light p-2 rounded"></pre></div>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- AI Configuration -->
    <div class="card mt-4">
      <div class="card-header"><h5>AI Configuration</h5></div>
      <div class="card-body">
        <table class="table">
          <tr>
            <td><strong>API URL</strong></td>
            <td><code><%= aiUrl %></code></td>
          </tr>
          <tr>
            <td><strong>Model</strong></td>
            <td><code><%= aiModel %></code></td>
          </tr>
          <tr>
            <td><strong>API Key</strong></td>
            <td><code><%= aiConfigured ? '••••••••' + aiKeyHint : 'Not set' %></code></td>
          </tr>
        </table>
        <small class="text-muted">Configure via <code>AI_API_KEY</code>, <code>AI_API_URL</code>, and <code>AI_MODEL</code> in <code>arm.yaml</code> or environment variables (<code>ARM_AI_API_KEY</code>, etc.).</small>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    function showResult(id, data) {
      var el = document.getElementById(id);
      el.style.display = 'block';
      el.querySelector('pre').textContent = JSON.stringify(data, null, 2);
    }

    async function aiCall(endpoint, body, resultId) {
      var el = document.getElementById(resultId);
      el.style.display = 'block';
      el.querySelector('pre').textContent = 'Calling...';
      try {
        var resp = await fetch('/api' + endpoint, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        var data = await resp.json();
        showResult(resultId, data);
      } catch (e) {
        showResult(resultId, { error: e.message });
      }
    }

    function tryIdentify() {
      var label = document.getElementById('identifyLabel').value;
      var disctype = document.getElementById('identifyDisctype').value;
      if (!label) { alert('Enter a disc label'); return; }
      aiCall('/ai/identify', { label: label, disctype: disctype }, 'identifyResult');
    }

    function tryTranscode() {
      var info = document.getElementById('transcodeInfo').value;
      var videoInfo = {};
      try { if (info.trim()) videoInfo = JSON.parse(info); } catch (e) { alert('Invalid JSON'); return; }
      aiCall('/ai/transcode', { videoInfo: videoInfo }, 'transcodeResult');
    }

    function tryDiagnose() {
      var log = document.getElementById('diagnoseLog').value;
      if (!log) { alert('Enter an error log'); return; }
      aiCall('/ai/diagnose', { errorLog: log }, 'diagnoseResult');
    }

    function tryFilename() {
      var title = document.getElementById('filenameTitle').value;
      var year = document.getElementById('filenameYear').value;
      var videoType = document.getElementById('filenameType').value;
      if (!title) { alert('Enter a title'); return; }
      aiCall('/ai/filename', { title: title, year: year, videoType: videoType }, 'filenameResult');
    }

    function tryCredits() {
      var title = document.getElementById('creditsTitle').value;
      var year = document.getElementById('creditsYear').value;
      var videoType = document.getElementById('creditsType').value;
      if (!title) { alert('Enter a title'); return; }
      aiCall('/ai/credits', { title: title, year: year, videoType: videoType }, 'creditsResult');
    }
  </script>
</body>
</html>
